<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.2.10/semantic.min.css"
          type="text/css">
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/railscasts.min.css"
          rel="stylesheet"/>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <script type="text/javascript"
            src="https://cdnjs.cloudflare.com/ajax/libs/jquery.address/1.6/jquery.address.min.js"></script>
    <script type="text/javascript"
            src="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.2.10/semantic.min.js"></script>
    <script type="text/javascript"
            src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
    <script type="text/javascript"
            src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/java.min.js"></script>
    <script type="text/javascript"
            src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/kotlin.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <style>
      

body {
  font-family: "Open Sans", "Helvetica", "Helvetica Neue",  "Arial", sans-serif;
  font-size:90%;
  color: black;
}

p {
  margin: 0.5em;
}

pre code {
  font-family: "Monaco";
  font-size: 100%;
}

img {
  box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19);
  margin:10px;
}

h1, h2, h3 {
  border-bottom:thin solid black;
  margin-bottom: 0.5em;
  margin-top: 1em;
}

h1 {
  font-style:italic;
  font-size:130%;
}

h2 {
  font-size:110%;
}

h3 {
  font-size:100%;
}



      

html, body {
  height: 100%;
  margin: 0;
}
.wrapper {
  height: 100%;
  display: flex;
  flex-direction: column;
}
.footer {
  background: white;
  text-align: right;
}
.content {
  flex: 1;
  overflow: auto;
}



    </style>
  </head>

  
  

  <div class="ui fixed top pointing inverted stackable menu labmenu">
    <header class="header item">
      <i id="toc" class="sitemap icon"></i>
      
        <a href="../index.html"> Week 9: Glitch: Sessions  </a>
      
    </header>
    <div class="right tab-menu menu">
      
        <a class="item" data-tab="Lab-9 Glitch Sessions">
          Lab-9 Glitch Sessions
        </a>
      
        <a class="item" data-tab="Exercise Solutions">
          Exercise Solutions
        </a>
      
        <a class="item" data-tab="01">
          01
        </a>
      
        <a class="item" data-tab="02">
          02
        </a>
      
        <a class="item" data-tab="03">
          03
        </a>
      
        <a class="item" data-tab="04">
          04
        </a>
      
        <a class="item" data-tab="05">
          05
        </a>
      
        <a class="item" data-tab="06">
          06
        </a>
      
        <a class="item" data-tab="07">
          07
        </a>
      
        <a class="item" data-tab="08">
          08
        </a>
      
        <a class="item" data-tab="Exercises">
          Exercises
        </a>
      
        <a class="item" data-tab="Solution">
          Solution
        </a>
      
    </div>
  </div>


  

  <div class="ui pushable">
    <div class="ui inverted labeled icon left inline vertical sidebar menu">
      <br><br>
      
        
          
            <a class="item"
               href="https://webappdevelopment.github.io/web-app-dev-2019//topic-01-html&css/book-a/index.html">Lab-01a Semantic UI </a>
          
        
      
        
          
            <a class="item"
               href="https://webappdevelopment.github.io/web-app-dev-2019//topic-01-html&css/book-b/index.html">Lab-01b Semantic UI </a>
          
        
      
        
          
            <a class="item"
               href="https://webappdevelopment.github.io/web-app-dev-2019//topic-02-glitch-intro/book-00-glitch-intro/index.html">Lab-2 Glitch Intro </a>
          
        
      
        
          
            <a class="item"
               href="https://webappdevelopment.github.io/web-app-dev-2019//topic-03-js-intro/book-a-js-introduction/index.html">Lab-3 JS Intro </a>
          
        
      
        
          
            <a class="item"
               href="https://webappdevelopment.github.io/web-app-dev-2019//topic-04-app-controllers-views/book-a-glitch-playlist-1/index.html">Lab-4 Glitch Playlist 1 </a>
          
        
      
        
          
            <a class="item"
               href="https://webappdevelopment.github.io/web-app-dev-2019//topic-05-app-templates-routes/book-a-glitch-playlist-2/index.html">Lab-5 Glitch Playlist 2 </a>
          
        
      
        
          
            <a class="item"
               href="https://webappdevelopment.github.io/web-app-dev-2019//topic-07-app-models/book-a-glitch-playlist-3/index.html">Lab-7 Glitch Playlist 3 </a>
          
        
      
        
          
            <a class="item"
               href="https://webappdevelopment.github.io/web-app-dev-2019//topic-08-js-arrays/book-a-js-arrays/index.html">Lab-8 JS Arrays </a>
          
        
      
        
          
            <a class="item"
               href="https://webappdevelopment.github.io/web-app-dev-2019//topic-09-glitch-sessions/book-a-glitch-sessions/index.html">Lab-9 Glitch Sessions </a>
          
        
      
    </div>
    <div class="pusher" tabindex="-1">
      <div class="ui basic segment">
        <br>
        
          <div class="ui tab segment lab" data-tab="Lab-9 Glitch Sessions">
            <h1>Objectives</h1>
<p>Introduce Sessions onto the Playlist application, enabling user accounts and cookie-based authentication.</p>

          </div>
        
          <div class="ui tab segment lab" data-tab="Exercise Solutions">
            <h1>Array Exercises</h1>
<p>The solutions from the JavaScript Arrays lab can be downloaded here: <a href="archives/week8.zip">week8.zip</a></p>

          </div>
        
          <div class="ui tab segment lab" data-tab="01">
            <h1>Playlist Model</h1>
<p>This lab is based on Playlist-4. This can be imported into a new Glitch project from <code>rbirney/playlist4-complete</code>.</p>
<p>In this lab we are going to create a user model (<code>user-store.json</code>) and manipulate it with methods stored in <code>user-store.js</code>. We will then associate each playlist with 
a specific user (by their id).</p>
<h2>models/playlist-store.js</h2>
<p>If your project has any playlists in the json store, delete them now. Your store should look like this:</p>
<h2>models/playlist-store.json</h2>
<pre><code>{
  &quot;playlistCollection&quot;: [
  ]
}</code></pre>
<p>We need a new method in the <code>playlist-store</code> module, which will retrieve a playlist based on a specific user id.</p>
<h2>models/playlist-store.js</h2>
<pre><code>...
  getUserPlaylists(userid) {
    return this.store.findBy(this.collection, { userid: userid });
  },
...</code></pre>
<p>This new method takes a userid, and will only fetch playlists belonging to the user with the specific id. 
We have not introduced the User model yet - we will do so now.</p>

          </div>
        
          <div class="ui tab segment lab" data-tab="02">
            <h1>Cookie Parser</h1>
<p>We need to install a new library in our project - in the form of a library to manage browser based cookies. This requires two steps:</p>
<h1>Update package.json</h1>
<h2>package.json</h2>
<p>This entry must go in:</p>
<pre><code>    &quot;cookie-parser&quot;: &quot;^1.4.3&quot;,</code></pre>
<p>This is the context, so replace the <code>dependencies</code> as follows:</p>
<pre><code>...
  &quot;dependencies&quot;: {
    &quot;body-parser&quot;: &quot;^1.15.2&quot;,
    &quot;cookie-parser&quot;: &quot;^1.4.3&quot;,
    &quot;express&quot;: &quot;^4.14.0&quot;,
    &quot;express-handlebars&quot;: &quot;^3.0.0&quot;,
    &quot;lodash&quot;: &quot;^4.17.3&quot;,
    &quot;lowdb&quot;: &quot;^0.14.0&quot;,
    &quot;uuid&quot;: &quot;^3.0.1&quot;,
    &quot;winston&quot;: &quot;^2.3.0&quot;
  },
...</code></pre>
<h1>Load the Library</h1>
<h2>server.js</h2>
<p>In server, we need to import and the initialise the library:</p>
<pre><code>...
const cookieParser = require(&#39;cookie-parser&#39;);
...
app.use(cookieParser());
...</code></pre>
<p>This is the complete server.js file:</p>
<pre><code>&#39;use strict&#39;;

const express = require(&#39;express&#39;);
const logger = require(&#39;./utils/logger&#39;);
const bodyParser = require(&#39;body-parser&#39;);
const cookieParser = require(&#39;cookie-parser&#39;);

const app = express();
app.use(cookieParser());
const exphbs = require(&#39;express-handlebars&#39;);
app.use(bodyParser.urlencoded({ extended: false, }));
app.use(express.static(&#39;public&#39;));
app.engine(&#39;.hbs&#39;, exphbs({
  extname: &#39;.hbs&#39;,
  defaultLayout: &#39;main&#39;,
}));
app.set(&#39;view engine&#39;, &#39;.hbs&#39;);

const routes = require(&#39;./routes&#39;);
app.use(&#39;/&#39;, routes);

const listener = app.listen(process.env.PORT || 4000, function () {
  logger.info(`Playlist 4 started on port ${listener.address().port}`);
});</code></pre>

          </div>
        
          <div class="ui tab segment lab" data-tab="03">
            <h1>UserStore</h1>
<p>Now we can introduce a new model:</p>
<h2>models/user-store.js</h2>
<pre><code>&#39;use strict&#39;;

const _ = require(&#39;lodash&#39;);
const JsonStore = require(&#39;./json-store&#39;);

const userStore = {

  store: new JsonStore(&#39;./models/user-store.json&#39;, {users: []}),
  collection: &#39;users&#39;,

  getAllUsers() {
    return this.store.findAll(this.collection);
  },

  addUser(user) {
    this.store.add(this.collection, user);
  },

  getUserById(id) {
    return this.store.findOneBy(this.collection, { id: id });
  },

  getUserByEmail(email) {
    return this.store.findOneBy(this.collection, { email: email });
  },
}

module.exports = userStore;</code></pre>
<h2>models/user-store.json</h2>
<pre><code>{
  &quot;users&quot;: [
    {
      &quot;firstName&quot;: &quot;homer&quot;,
      &quot;lastName&quot;: &quot;simpson&quot;,
      &quot;email&quot;: &quot;homer@simpson.com&quot;,
      &quot;password&quot;: &quot;secret&quot;,
      &quot;id&quot;: &quot;3ad52697-6d98-4d80-8273-084de55a86c0&quot;
    },
    {
      &quot;firstName&quot;: &quot;marge&quot;,
      &quot;lastName&quot;: &quot;simpson&quot;,
      &quot;email&quot;: &quot;marge@simpson.com&quot;,
      &quot;password&quot;: &quot;secret&quot;,
      &quot;id&quot;: &quot;2b6f0989-7b7f-4a38-ad26-aa06b922d751&quot;
    }
  ]
}</code></pre>
<p>In the above we are pre-loading two users for test purposes.</p>

          </div>
        
          <div class="ui tab segment lab" data-tab="04">
            <h1>Accounts views</h1>
<p>We need a suite of new views to support signup / login, so create the following files:</p>
<h2>views/index.hbs</h2>
<pre><code>{{&gt; welcomemenu }}

&lt;section class=&quot;ui center aligned middle aligned segment&quot;&gt;
  &lt;p&gt; Sign up or Log in... &lt;/p&gt;
&lt;/section&gt;</code></pre>
<h2>views/login.hbs</h2>
<pre><code>{{&gt; welcomemenu id=&#39;login&#39; }}

&lt;form class=&quot;ui stacked segment form&quot; action=&quot;/authenticate&quot; method=&quot;POST&quot;&gt;
  &lt;h3 class=&quot;ui header&quot;&gt;Log-in&lt;/h3&gt;
  &lt;div class=&quot;field&quot;&gt;
    &lt;label&gt;Email&lt;/label&gt; &lt;input placeholder=&quot;Email&quot; name=&quot;email&quot; autofocus required&gt;
  &lt;/div&gt;
  &lt;div class=&quot;field&quot;&gt;
    &lt;label&gt;Password&lt;/label&gt; &lt;input type=&quot;password&quot;  name=&quot;password&quot; required &gt;
  &lt;/div&gt;
  &lt;button class=&quot;ui blue submit button&quot;&gt;Login&lt;/button&gt;
&lt;/form&gt;</code></pre>
<h2>views/signup.hbs</h2>
<pre><code>{{&gt; welcomemenu id=&quot;signup&quot;}}

&lt;form class=&quot;ui stacked segment form&quot; action=&quot;/register&quot; method=&quot;POST&quot;&gt;
  &lt;h3 class=&quot;ui header&quot;&gt;Register&lt;/h3&gt;
  &lt;div class=&quot;two fields&quot;&gt;
    &lt;div class=&quot;field&quot;&gt;
      &lt;label&gt;First Name&lt;/label&gt;
      &lt;input placeholder=&quot;First Name&quot; type=&quot;text&quot;  name=&quot;firstName&quot; autofocus required&gt;
    &lt;/div&gt;
    &lt;div class=&quot;field&quot;&gt;
      &lt;label&gt;Last Name&lt;/label&gt;
      &lt;input placeholder=&quot;Last Name&quot; type=&quot;text&quot;  name=&quot;lastName&quot; required&gt;
    &lt;/div&gt;
  &lt;/div&gt;
  &lt;div class=&quot;field&quot;&gt;
    &lt;label&gt;Email&lt;/label&gt;
    &lt;input placeholder=&quot;Email&quot; type=&quot;text&quot; name=&quot;email&quot; required&gt;
  &lt;/div&gt;
  &lt;div class=&quot;field&quot;&gt;
    &lt;label&gt;Password&lt;/label&gt;
    &lt;input type=&quot;password&quot; name=&quot;password&quot; required&gt;
  &lt;/div&gt;
  &lt;button class=&quot;ui blue submit button&quot;&gt;Submit&lt;/button&gt;
&lt;/form&gt;</code></pre>
<p>In addition, a new menu which will support the above views:</p>
<h2>views/partials/welcomemenu.hbs</h2>
<pre><code>&lt;nav class=&quot;ui menu&quot;&gt;
  &lt;header class=&quot;ui header item&quot;&gt; &lt;a href=&quot;/&quot;&gt; Playlist 4 &lt;/a&gt;&lt;/header&gt;
  &lt;div class=&quot;right menu&quot;&gt;
    &lt;a id=&quot;signup&quot; class=&quot;item&quot; href=&quot;/signup&quot;&gt; Signup  &lt;/a&gt;
    &lt;a id=&quot;login&quot; class=&quot;item&quot; href=&quot;/login&quot;&gt;  Login   &lt;/a&gt;
  &lt;/div&gt;
&lt;/nav&gt;

&lt;script&gt;
  $(&quot;#{{id}}&quot;).addClass(&quot;active item&quot;);
&lt;/script&gt;</code></pre>
<p>We need to extend the menu partial - which will introduce a new menu option to allow a user to log out. And, we will display the name of the logged in user:</p>
<h2>views/partials/menu.hbs</h2>
<pre><code>&lt;nav class=&quot;ui menu&quot;&gt;
  &lt;header class=&quot;ui header item&quot;&gt; &lt;a href=&quot;/start&quot;&gt; Playlist 4 &lt;/a&gt;&lt;/header&gt;
  &lt;div class=&quot;right menu&quot;&gt;
    &lt;span class=&quot;name&quot;&gt;{{fullname}}&lt;/span&gt;
    &lt;a id=&quot;dashboard&quot; class=&quot;item&quot; href=&quot;/dashboard&quot;&gt; Dashboard  &lt;/a&gt;
    &lt;a id=&quot;about&quot; class=&quot;item&quot; href=&quot;/about&quot;&gt; About &lt;/a&gt;
    &lt;a id=&quot;logout&quot; class=&quot;item&quot; href=&quot;/logout&quot;&gt; Logout &lt;/a&gt;
  &lt;/div&gt;
&lt;/nav&gt;

&lt;script&gt;
  $(&quot;#{{id}}&quot;).addClass(&quot;active item&quot;);
&lt;/script&gt;</code></pre>
<h2>public/stylesheets/style.css</h2>
<p>And finally, we need to create a file called <code>style.css</code> (public/stylesheets/style.css) and add the following style rule: </p>
<pre><code>.name{
  padding-top:20px;
  padding-right:5px;
  line-height:20px;
  font-weight:bold;
}</code></pre>

          </div>
        
          <div class="ui tab segment lab" data-tab="05">
            <h1>Accounts controller</h1>
<p>This is a new controller to support these views:</p>
<h2>controllers/accounts.js</h2>
<pre><code>&#39;use strict&#39;;
const userstore = require(&#39;../models/user-store&#39;);
const logger = require(&#39;../utils/logger&#39;);
const uuid = require(&#39;uuid&#39;);

const accounts = {

  index(request, response) {
    const viewData = {
      title: &#39;Login or Signup&#39;,
    };
    response.render(&#39;index&#39;, viewData);
  },

  login(request, response) {
    const viewData = {
      title: &#39;Login to the Service&#39;,
    };
    response.render(&#39;login&#39;, viewData);
  },

  logout(request, response) {
    response.cookie(&#39;playlist&#39;, &#39;&#39;);
    response.redirect(&#39;/&#39;);
  },

  signup(request, response) {
    const viewData = {
      title: &#39;Login to the Service&#39;,
    };
    response.render(&#39;signup&#39;, viewData);
  },

  register(request, response) {
    const user = request.body;
    user.id = uuid();
    userstore.addUser(user);
    logger.info(`registering ${user.email}`);
    response.redirect(&#39;/&#39;);
  },

  authenticate(request, response) {
    const user = userstore.getUserByEmail(request.body.email);
    if (user) {
      response.cookie(&#39;playlist&#39;, user.email);
      logger.info(`logging in ${user.email}`);
      response.redirect(&#39;/start&#39;);
    } else {
      response.redirect(&#39;/login&#39;);
    }
  },

  getCurrentUser (request) {
    const userEmail = request.cookies.playlist;
    return userstore.getUserByEmail(userEmail);
  }
}

module.exports = accounts;</code></pre>

          </div>
        
          <div class="ui tab segment lab" data-tab="06">
            <h1>Routes</h1>
<p>These new views and controller  all require new routes:</p>
<h2>routes.js</h2>
<p>In particular, these specific routes:</p>
<pre><code>...
router.get(&#39;/&#39;, accounts.index);
router.get(&#39;/login&#39;, accounts.login);
router.get(&#39;/signup&#39;, accounts.signup);
router.get(&#39;/logout&#39;, accounts.logout);
router.post(&#39;/register&#39;, accounts.register);
router.post(&#39;/authenticate&#39;, accounts.authenticate);
...</code></pre>
<p>This is the complete revised routes.js file:</p>
<pre><code>&#39;use strict&#39;;

const express = require(&#39;express&#39;);
const router = express.Router();

const start = require(&#39;./controllers/start&#39;);
const dashboard = require(&#39;./controllers/dashboard.js&#39;);
const playlist = require(&#39;./controllers/playlist.js&#39;);
const about = require(&#39;./controllers/about.js&#39;);
const accounts = require (&#39;./controllers/accounts.js&#39;);

router.get(&#39;/&#39;, accounts.index);
router.get(&#39;/login&#39;, accounts.login);
router.get(&#39;/signup&#39;, accounts.signup);
router.get(&#39;/logout&#39;, accounts.logout);
router.post(&#39;/register&#39;, accounts.register);
router.post(&#39;/authenticate&#39;, accounts.authenticate);

router.get(&#39;/start&#39;, start.index);

router.get(&#39;/dashboard&#39;, dashboard.index);
router.get(&#39;/dashboard/deleteplaylist/:id&#39;, dashboard.deletePlaylist);
router.post(&#39;/dashboard/addplaylist&#39;, dashboard.addPlaylist);

router.get(&#39;/playlist/:id&#39;, playlist.index);
router.get(&#39;/playlist/:id/deletesong/:songid&#39;, playlist.deleteSong);
router.post(&#39;/playlist/:id/addsong&#39;, playlist.addSong);
router.post(&#39;/playlist/:id/updatesong/:songid&#39;, playlist.updateSong);

router.get(&#39;/about&#39;, about.index);

module.exports = router;</code></pre>
<p>The application should be running now. You should see these new views:</p>
<h3>A new landing page</h3>
<p><img src="img/02.png" alt=""></p>
<h3>Signup</h3>
<p><img src="img/04.png" alt=""></p>
<h3>login</h3>
<p><img src="img/03.png" alt=""></p>

          </div>
        
          <div class="ui tab segment lab" data-tab="07">
            <h1>Start</h1>
<p>When the user logs in, the first page (<code>start.hbs</code>) will welcome them by name. Replace <code>start.hbs</code> with the following:</p>
<pre><code>{{&gt; menu}}

&lt;section class=&quot;ui center aligned middle aligned segment&quot;&gt;
  &lt;h1 class=&quot;ui header&quot;&gt;
    Welcome {{fullname}} to the Playlist 
  &lt;/h1&gt;
  &lt;p&gt;
    A small app to let you compose playlists. Still under construction...
  &lt;/p&gt;
&lt;/section&gt;</code></pre>
<h1>Dashboard</h1>
<p>Try the following now:</p>
<ul>
<li>Log in as &#39;homer@simpson.com&#39;, &#39;secret&#39;.</li>
<li>Add a playlist called &#39;test&#39;.</li>
<li>Log out.</li>
<li>Log in as &#39;marge@simpson.com&#39;, &#39;secret&#39;.</li>
</ul>
<p>Notice that we are seeing Homers test playlist even when we log in as Marge. The playlist-store.json may look like this:</p>
<pre><code>{
  &quot;playlistCollection&quot;: [
    {
      &quot;id&quot;: &quot;4a1ea4ec-303e-4b13-bd98-a6b04877e093&quot;,
      &quot;title&quot;: &quot;test&quot;,
      &quot;songs&quot;: []
    }
  ]
}</code></pre>
<p>Remember to open the <code>console</code> and enter the <code>refresh</code> command to ensure the collections are uptodate.</p>
<p>This clearly is not what we were aiming for. We should only present the users own playlists.</p>
<p>Here is how do it - all changes to the dashboard module:</p>
<h2>controllers/dashboard.js</h2>
<p>In the top of the module, import the new accounts module:</p>
<pre><code>...
const accounts = require (&#39;./accounts.js&#39;);
...</code></pre>
<p>Revised index action:</p>
<pre><code>...
  index(request, response) {
    logger.info(&#39;dashboard rendering&#39;);
    const loggedInUser = accounts.getCurrentUser(request);
    if (loggedInUser) {
    const viewData = {
      title: &#39;Playlist Dashboard&#39;,
      playlists: playlistStore.getUserPlaylists(loggedInUser.id),
      fullname: loggedInUser.firstName + &#39; &#39; + loggedInUser.lastName,
    };
    logger.info(&#39;about to render&#39;, viewData.playlists);
    response.render(&#39;dashboard&#39;, viewData);
    }
    else response.redirect(&#39;/&#39;);
  },
...</code></pre>
<p>This revised <code>index</code> action returns an object for the user logged in. Using the <code>loggedInUser.id</code> the playlist associated with that user is returned and the full name
is created by concatenating the the loggedInUser.firstName and loggedInUser.lastName. The playlist will be
available to the dashboard and the full name is displayed on each subsequent page rendered (through <code>menu.hbs</code>).</p>
<p>Revised addPlaylist action:</p>
<pre><code>...
  addPlaylist(request, response) {
    const loggedInUser = accounts.getCurrentUser(request);
    const newPlayList = {
      id: uuid(),
      userid: loggedInUser.id,
      title: request.body.title,
      songs: [],
    };
    logger.debug(&#39;Creating a new Playlist&#39;, newPlayList);
    playlistStore.addPlaylist(newPlayList);
    response.redirect(&#39;/dashboard&#39;);
  },
...</code></pre>
<p>Log in as marge and homer in turn, creating a single playlist (use a name you will remember). Make sure that the appropriate playlist appears in each users dashboard.</p>
<h2>The Stores</h2>
<p>Looking at the playlist-store.json - it might (eventually when loaded) look like this:</p>
<pre><code>{
  &quot;playlistCollection&quot;: [
    {
      &quot;id&quot;: &quot;4a1ea4ec-303e-4b13-bd98-a6b04877e093&quot;,
      &quot;title&quot;: &quot;test&quot;,
      &quot;songs&quot;: []
    },
    {
      &quot;id&quot;: &quot;1e6ed5a0-28fe-4527-8ce8-6cb5c800b5be&quot;,
      &quot;userid&quot;: &quot;2b6f0989-7b7f-4a38-ad26-aa06b922d751&quot;,
      &quot;title&quot;: &quot;marges playlist&quot;,
      &quot;songs&quot;: []
    },
    {
      &quot;id&quot;: &quot;07dd66fe-9f8f-456c-944d-48330bde4610&quot;,
      &quot;userid&quot;: &quot;3ad52697-6d98-4d80-8273-084de55a86c0&quot;,
      &quot;title&quot;: &quot;homers playlist&quot;,
      &quot;songs&quot;: []
    }
  ]
}</code></pre>
<p>Examine it carefully - notice that the very first playlist is &#39;orphaned&#39; - it has no userid. The others have userid - which correlates the playlists with the user in the users store:</p>
<pre><code>{
  &quot;users&quot;: [
    {
      &quot;firstName&quot;: &quot;homer&quot;,
      &quot;lastName&quot;: &quot;simpson&quot;,
      &quot;email&quot;: &quot;homer@simpson.com&quot;,
      &quot;password&quot;: &quot;secret&quot;,
      &quot;id&quot;: &quot;3ad52697-6d98-4d80-8273-084de55a86c0&quot;
    },
    {
      &quot;firstName&quot;: &quot;marge&quot;,
      &quot;lastName&quot;: &quot;simpson&quot;,
      &quot;email&quot;: &quot;marge@simpson.com&quot;,
      &quot;password&quot;: &quot;secret&quot;,
      &quot;id&quot;: &quot;2b6f0989-7b7f-4a38-ad26-aa06b922d751&quot;
    }
  ]
}</code></pre>

          </div>
        
          <div class="ui tab segment lab" data-tab="08">
            <h1>Revised controller/ *.js modules</h1>
<p>The <code>about.js</code>, <code>start.js</code> and <code>playlist.js</code> modules also need to keep track of the logged in user, so in each module, we need to import the <code>accounts</code> module. 
In each module add the following statement (after or before the other <code>require</code> statement(s)):</p>
<pre><code>const accounts = require (&#39;./accounts.js&#39;);</code></pre>
<h2>Revised index action</h2>
<p>In the <code>index</code> action for each module, we need to return an object for the logged in user to check that a user is actually logged in and if so extract their full name.</p>
<h3>Revised index action (about.js)</h3>
<pre><code>index(request, response) {
    const loggedInUser = accounts.getCurrentUser(request);  
    logger.info(&#39;about rendering&#39;);
    if (loggedInUser) {
    const viewData = {
      title: &#39;About Playlist 1&#39;,
      fullname: loggedInUser.firstName + &#39; &#39; + loggedInUser.lastName,
    };
    response.render(&#39;about&#39;, viewData);
   }
    else response.redirect(&#39;/&#39;);
},</code></pre>
<h3>Revised index action (start.js)</h3>
<pre><code>index(request, response) {
    const loggedInUser = accounts.getCurrentUser(request);  
    logger.info(&#39;start rendering&#39;);
    if (loggedInUser) {
    const viewData = {
      title: &#39;Welcome to Playlist 1&#39;,
      fullname: loggedInUser.firstName + &#39; &#39; + loggedInUser.lastName,
    };
    response.render(&#39;start&#39;, viewData);
    }
    else response.redirect(&#39;/&#39;);
},</code></pre>
<h3>Revised index action (playlist.js)</h3>
<pre><code>index(request, response) {
    const loggedInUser = accounts.getCurrentUser(request);  
    const playlistId = request.params.id;
    logger.debug(&#39;Playlist id = &#39;, playlistId);
    if (loggedInUser) {
    const viewData = {
      title: &#39;Playlist&#39;,
      playlist: playlistStore.getPlaylist(playlistId),
      fullname: loggedInUser.firstName + &#39; &#39; + loggedInUser.lastName,
    };
    response.render(&#39;playlist&#39;, viewData);
    }
    else response.redirect(&#39;/&#39;);
},</code></pre>

          </div>
        
          <div class="ui tab segment lab" data-tab="Exercises">
            <h1>Exercises</h1>
<h2>Exercise 1</h2>
<p>Test the application more comprehensively - signing up a range of users, and creating playlists. Make sure the users only see the playlists they have created.</p>
<h2>Exercise 2</h2>
<p>Look at the <code>authenticate</code> method again:</p>
<pre><code>  authenticate(request, response) {
    const user = userstore.getUserByEmail(request.body.email);
    if (user) {
      response.cookie(&#39;playlist&#39;, user.email);
      logger.info(`logging in ${user.email}`);
      response.redirect(&#39;/dashboard&#39;);
    } else {
      response.redirect(&#39;/login&#39;);
    }
  },</code></pre>
<p>Can you see anything not quite right about it?</p>
<p>Hint: what happens if incorrect password entered? Try this now.</p>
<p>See if you can fix this problem - i.e. only allow user to log in if they provide correct password.</p>
<h2>Exercise 3</h2>
<p>Using this lab as a guide - see if you can introduce sessions into your own project.</p>

          </div>
        
          <div class="ui tab segment lab" data-tab="Solution">
            <h1>Lab Solution</h1>
<p>A completed version of the lab can be imported into a new Glitch project from <code>rbirney/playlist5-complete</code>.</p>

          </div>
        
      </div>
    </div>
  </div>



  <script>
    $(document).on('keydown', function(e) {
  e = e || window.event;
  var nextTab;
  switch (e.which || e.keyCode) {
    case 37: // left
      nextTab = $('.tab-menu a[data-tab].active').prev('a[data-tab]');
      if (!nextTab.length) nextTab = $('.tab-menu a[data-tab]').last();
      nextTab.click();
      $('.pusher').focus();
      break;

    case 39: // right
      nextTab = $('.tab-menu a[data-tab].active').next('a[data-tab]');
      if (!nextTab.length) nextTab = $('.tab-menu a[data-tab]').first();
      nextTab.click();
      $('.pusher').focus();
      break;
  }
});

    $(document).ready(function() {
  $('img').addClass('ui image');

  $('.ui.embed').embed();

  const $images = $('.lab img');
  jQuery.each($images, function(i) {
    if ($images[i].alt.length > 0) {
      const divImg = $(document.createElement('div')).addClass(
        'ui basic segment',
      );
      $($images[i]).wrap(divImg);
      const divLabel = $(document.createElement('div')).addClass(
        'ui blue ribbon label',
      );
      divLabel.append($images[i].alt);
      $(divLabel).insertBefore($images[i]);
    }
  });

  $('.ui.menu .item').tab({
    history: true,
    historyType: 'hash',
  });

  $('.popup').popup();

  $('.ui.sidebar')
    .sidebar({ context: $('.pushable') })
    .sidebar('setting', 'transition', 'slide out')
    .sidebar('attach events', '#toc');
});

  </script>



  <div class="ui bottom fixed borderless right menu">
    <div class="ui right small menu">
      <div class="ui tiny basic message segment">
         Powered by <a href="https://github.com/edeleastar/tutors-ts">tutors-ts.</a> 
      </div>
    </div>
  </div>

  </body>

</html>